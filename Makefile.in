.PHONY: build build_ext clean install help
.ONESHELL:
.SHELL := /bin/bash
.EXPORT_ALL_VARIABLES:

CURRENT_FOLDER=$(shell basename "$$(pwd)")
PYTHON_CMD ?= $(shell command -v python3 || command -v python)
PYTHON_LIB := $(shell $(PYTHON_CMD) -c "import sys; print(f'python{sys.version_info.major}.{sys.version_info.minor}')")
PYTHON_VERSION := $(shell $(PYTHON_CMD) -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
PYTHON_FULL_VERSION := $(shell $(PYTHON_CMD) -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}')")

# Configure-substituted variables
PYTHON_INCLUDE = @PYTHON_INCLUDE@
PYTHON_LIB = @PYTHON_LIB@
LIBEV_INCLUDE = @LIBEV_INCLUDE@
LIBEV_LIB = @LIBEV_LIB@
GETTEXT_INCLUDE = @GETTEXT_INCLUDE@
GETTEXT_LIB = @GETTEXT_LIB@
OUTPUT = @OUTPUT@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@

# Compiler flags from configure
CFLAGS = @CFLAGS@ -DLIB_DIR=\"$(libdir)\" -fPIC -O2 -Wall
CPPFLAGS = @CPPFLAGS@ -I$(PYTHON_INCLUDE) -I$(LIBEV_INCLUDE) -I$(GETTEXT_INCLUDE)
LDFLAGS = @LDFLAGS@ -L$(LIBEV_LIB) -L$(GETTEXT_LIB) -l$(PYTHON_LIB) -lz -lev

ifneq ($(OS),Windows_NT)
	UNAME_S := $(shell uname -s)
	ifeq ($(UNAME_S),Darwin)
		BREWERY_HOME := $(shell brew --prefix)
		LDFLAGS := $(BREWERY_HOME)/opt/python@$(PYTHON_VERSION)/Frameworks/Python.framework/Versions/$(PYTHON_VERSION)/Python \
			$(BREWERY_HOME)/Cellar/python@$(PYTHON_VERSION)/$(PYTHON_FULL_VERSION)/Frameworks/Python.framework/Versions/$(PYTHON_VERSION)/lib/python$(PYTHON_VERSION)/config-$(PYTHON_VERSION)-darwin/libpython$(PYTHON_VERSION).a \
			$(BREWERY_HOME)/opt/gettext/lib/libintl.a
	endif
endif

build: build_ext ## Build the application
	@gcc $(CFLAGS) $(CPPFLAGS) \
	main_wrapper.c $(shell cat sources.txt) \
	$(LDFLAGS) \
	-lz -lm -ldl -liconv \
	-o $(OUTPUT)

test:
	@echo $(DESTDIR)
	@echo $(bindir)
	@echo $(libdir)
	@echo $(PYTHON_VERSION)

# static: build_ext ## Build the application statically
# 	@gcc $(CFLAGS) $(CPPFLAGS) -static \
# 	main_wrapper.c $(shell cat sources.txt) \
# 	$(LDFLAGS) -Wl,--whole-archive -l:libpython3.11.a -l:libev.a -l:libz.a -Wl,--no-whole-archive \
# 	-o $(OUTPUT)

install: build ## Install the application
	install -d $(DESTDIR)$(bindir)
	install -m 755 $(OUTPUT) $(DESTDIR)$(bindir)/
	mkdir -p $(DESTDIR)$(libdir)
	cp -a build/lib.*/* $(DESTDIR)$(libdir)

build_ext: ## Build Cython extensions
	@$(PYTHON_CMD) setup_build.py build_ext --inplace

clean: ## Remove build artifacts
	@rm -rf build
	@rm -f cqlshlib/*.c
	@find cassandra -name "*.c" -exec rm -f {} \;
	@find wcwidth -name "*.c" -exec rm -f {} \;

help: ## Show this help message
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

# code: language=Makefile
