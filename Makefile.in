.PHONY: build build_ext clean install help
.ONESHELL:
.SHELL := /bin/bash
.EXPORT_ALL_VARIABLES:

CURRENT_FOLDER=$(shell basename "$$(pwd)")

# Configure-substituted variables
PYTHON_INCLUDE = @PYTHON_INCLUDE@
PYTHON_LIB = @PYTHON_LIB@
LIBEV_INCLUDE = @LIBEV_INCLUDE@
LIBEV_LIB = @LIBEV_LIB@
GETTEXT_INCLUDE = @GETTEXT_INCLUDE@
GETTEXT_LIB = @GETTEXT_LIB@
OUTPUT = @OUTPUT@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@

# Compiler flags from configure
CFLAGS = @CFLAGS@ -DLIB_DIR=\"$(libdir)\" -fPIC -O2 -Wall
CPPFLAGS = @CPPFLAGS@ -I$(PYTHON_INCLUDE) -I$(LIBEV_INCLUDE) -I$(GETTEXT_INCLUDE)
LDFLAGS = @LDFLAGS@ -L$(LIBEV_LIB) -L$(GETTEXT_LIB)
	
build: build_ext ## Build the application
	@gcc $(CFLAGS) $(CPPFLAGS) \
	main_wrapper.c $(shell cat sources.txt) \
	$(LDFLAGS) -lev -lpython3.11 \
	-o $(OUTPUT)

test:
	@echo $(DESTDIR)
	@echo $(bindir)
	@echo $(libdir)

# static: build_ext ## Build the application statically
# 	@gcc $(CFLAGS) $(CPPFLAGS) -static \
# 	main_wrapper.c $(shell cat sources.txt) \
# 	$(LDFLAGS) -Wl,--whole-archive -l:libpython3.11.a -l:libev.a -l:libz.a -Wl,--no-whole-archive \
# 	-o $(OUTPUT)

install: build ## Install the application
	install -d $(DESTDIR)$(bindir)
	install -m 755 $(OUTPUT) $(DESTDIR)$(bindir)/
	mkdir -p $(DESTDIR)$(libdir)
	cp -a build/lib.*/* $(DESTDIR)$(libdir)

build_ext: ## Build Cython extensions
	@python3 setup_build.py build_ext --inplace

clean: ## Remove build artifacts
	@rm -rf build
	@rm -f cqlshlib/*.c
	@find cassandra -name "*.c" -exec rm -f {} \;
	@find wcwidth -name "*.c" -exec rm -f {} \;

help: ## Show this help message
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

# code: language=Makefile
